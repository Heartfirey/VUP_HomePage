// src/components/LiveRecord/Timeline.js
import React, { useState } from 'react';
import clsx from 'clsx';
import dayjs from 'dayjs';

// å¯¼å…¥MUIå›¾æ ‡
import MusicNoteIcon from '@mui/icons-material/MusicNote';
import EmojiEventsIcon from '@mui/icons-material/EmojiEvents';
import ChatBubbleIcon from '@mui/icons-material/ChatBubble';
import FlagIcon from '@mui/icons-material/Flag';
import PlayArrowIcon from '@mui/icons-material/PlayArrow';
import StopIcon from '@mui/icons-material/Stop';
import PauseIcon from '@mui/icons-material/Pause';
import StarIcon from '@mui/icons-material/Star';

const iconMap = {
    song: MusicNoteIcon,
    milestone: EmojiEventsIcon,
    chat: ChatBubbleIcon,
    flag: FlagIcon,
    start: PlayArrowIcon,
    end: StopIcon,
    break: PauseIcon,
    highlight: StarIcon
};

const Timeline = ({ points = [], streamStartTime, duration, className }) => {
    const [hoveredPoint, setHoveredPoint] = useState(null);
    const [selectedPoint, setSelectedPoint] = useState(null);
    
    // å¤„ç†æ—¶é—´è½´æ•°æ®ï¼Œè‡ªåŠ¨æ·»åŠ å¼€å§‹å’Œç»“æŸäº‹ä»¶
    const processTimelinePoints = () => {
        const processedPoints = [...points];
        
        if (!streamStartTime) {
            return processedPoints;
        }
        
        const startTimestamp = dayjs(streamStartTime).unix();
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼€å§‹äº‹ä»¶
        const hasStartEvent = processedPoints.some(point => 
            point.type === 'start' || Math.abs(point.time - startTimestamp) < 60
        );
        
        // å¦‚æœæ²¡æœ‰å¼€å§‹äº‹ä»¶ï¼Œè‡ªåŠ¨æ·»åŠ 
        if (!hasStartEvent) {
            processedPoints.unshift({
                id: 'auto_start',
                type: 'start',
                name: 'ç›´æ’­å¼€å§‹',
                time: startTimestamp,
                url: '',
                note: 'ç›´æ’­æ­£å¼å¼€å§‹',
                backgroundColor: 'rgba(0, 230, 118, 0.3)',
                foregroundColor: 'rgba(0, 230, 118)',
                isAutoGenerated: true
            });
        }
        
        // å¦‚æœæœ‰durationï¼Œæ·»åŠ ç»“æŸäº‹ä»¶
        if (duration && duration > 0) {
            const endTimestamp = startTimestamp + (duration * 60); // durationæ˜¯åˆ†é’Ÿï¼Œè½¬ä¸ºç§’
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æŸäº‹ä»¶
            const hasEndEvent = processedPoints.some(point => 
                point.type === 'end' || Math.abs(point.time - endTimestamp) < 60
            );
            
            if (!hasEndEvent) {
                processedPoints.push({
                    id: 'auto_end',
                    type: 'end', 
                    name: 'ç›´æ’­ç»“æŸ',
                    time: endTimestamp,
                    url: '',
                    note: 'ç›´æ’­æ­£å¼ç»“æŸ',
                    backgroundColor: 'rgba(200,200,200,0.5)',
                    foregroundColor: 'rgba(200,200,200,1)',
                    isAutoGenerated: true
                });
            }
        }
        
        return processedPoints;
    };
    
    const allPoints = processTimelinePoints();
    
    if (!allPoints || allPoints.length === 0) {
        return (
            <div className={clsx("flex items-center justify-center p-8", className)}>
                <div className="text-gray-400 text-sm">æš‚æ— æ—¶é—´è½´æ•°æ®</div>
            </div>
        );
    }
    
    // æŒ‰æ—¶é—´æ’åºç‚¹
    const sortedPoints = [...allPoints].sort((a, b) => a.time - b.time);
    
    // å‡åŒ€åˆ†å¸ƒæ—¶é—´ç‚¹ä½ç½®ï¼ˆä¸æŒ‰çœŸå®æ—¶é—´æ¯”ä¾‹ï¼‰
    const getPointPosition = (index, totalPoints) => {
        if (totalPoints === 1) return 50; // å•ä¸ªç‚¹å±…ä¸­
        
        // ç•™å‡ºä¸¤è¾¹çš„è¾¹è·ï¼Œåœ¨ä¸­é—´åŒºåŸŸå‡åŒ€åˆ†å¸ƒ
        const leftMargin = 5; // 5%
        const rightMargin = 5; // 5%
        const availableWidth = 100 - leftMargin - rightMargin; // 90%
        
        if (totalPoints === 2) {
            return index === 0 ? leftMargin + availableWidth * 0.2 : leftMargin + availableWidth * 0.8;
        }
        
        // å¤šä¸ªç‚¹çš„æƒ…å†µï¼Œå‡åŒ€åˆ†å¸ƒ
        const step = availableWidth / (totalPoints - 1);
        return leftMargin + (index * step);
    };
    
    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    const formatTime = (timestamp) => {
        const time = dayjs.unix(timestamp);
        const streamStart = dayjs(streamStartTime);
        const diff = time.diff(streamStart, 'minute');
        
        if (diff < 60) {
            return `${diff}åˆ†é’Ÿ`;
        } else {
            const hours = Math.floor(diff / 60);
            const minutes = diff % 60;
            return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
        }
    };
    
    const TimelinePoint = ({ point, position, index }) => {
        const IconComponent = iconMap[point.type] || StarIcon;
        const isHovered = hoveredPoint === point.id;
        const isSelected = selectedPoint === point.id;
        
        return (
            <div
                className="absolute transform -translate-x-1/2"
                style={{ 
                    left: `${position}%`,
                    top: '24px', // è°ƒæ•´ä½ç½®è®©æ—¶é—´ç‚¹å±…ä¸­
                    zIndex: isHovered || isSelected ? 50 : 20
                }}
            >
                {/* Points on timeline - ç®€åŒ–ç»“æ„ */}
                <div
                    className={clsx(
                        "relative cursor-pointer transition-all duration-200",
                        "hover:scale-110"
                    )}
                    onMouseEnter={() => setHoveredPoint(point.id)}
                    onMouseLeave={() => setHoveredPoint(null)}
                    onClick={() => setSelectedPoint(isSelected ? null : point.id)}
                >
                    {/* Icon point - ç›´æ¥æ˜¾ç¤ºï¼Œä¸éœ€è¦è¿æ¥çº¿ */}
                    <div
                        className={clsx(
                            "w-8 h-8 rounded-full flex items-center justify-center",
                            "border-2 transition-all duration-200 relative",
                            isHovered && "shadow-lg scale-110",
                            isSelected && "ring-2 ring-white ring-opacity-50"
                        )}
                        style={{
                            backgroundColor: point.backgroundColor || 'rgba(255,255,255,0.1)',
                            borderColor: point.foregroundColor || '#666'
                        }}
                    >
                        <IconComponent 
                            sx={{ 
                                fontSize: 16, 
                                color: point.foregroundColor || '#666' 
                            }} 
                        />
                    </div>
                    
                    {/* Hover bubble - æ”¹è¿›å®šä½é€»è¾‘ */}
                    {(isHovered || isSelected) && (
                        <div 
                            className={clsx(
                                "absolute z-50",
                                "bg-black/95 text-white text-xs rounded-lg p-3 min-w-max max-w-xs",
                                "shadow-xl backdrop-blur-sm border border-white/20"
                            )}
                            style={{
                                bottom: '45px', // è°ƒæ•´ä¸ºé€‚åº”ç®€åŒ–çš„å¸ƒå±€
                                left: '50%',
                                transform: 'translateX(-50%)',
                                // è¾¹ç•Œæ£€æµ‹ï¼šå¦‚æœå¤ªé è¾¹åˆ™è°ƒæ•´ä½ç½®
                                ...(position < 15 && { 
                                    left: '0px', 
                                    transform: 'translateX(0%)' 
                                }),
                                ...(position > 85 && { 
                                    right: '0px', 
                                    left: 'auto',
                                    transform: 'translateX(0%)' 
                                })
                            }}
                        >
                            <div className="font-medium">{point.name}</div>
                            <div className="text-gray-300 mt-1">
                                {formatTime(point.time)}
                            </div>
                            {point.note && point.note.trim() && (
                                <div className="text-gray-400 mt-1 text-xs">
                                    {point.note}
                                </div>
                            )}
                            {point.url && point.url.trim() && (
                                <a 
                                    href={point.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-blue-400 hover:text-blue-300 text-xs mt-1 block"
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    ğŸ”— æŸ¥çœ‹è¯¦æƒ…
                                </a>
                            )}
                            
                            {/* ç®­å¤´æŒ‡å‘æ—¶é—´ç‚¹ - ç®€åŒ–å®šä½é€»è¾‘ */}
                            <div 
                                className="absolute"
                                style={{
                                    bottom: '-4px',
                                    left: position < 15 ? '16px' : position > 85 ? 'calc(100% - 20px)' : '50%',
                                    transform: 'translateX(-50%)',
                                    width: 0,
                                    height: 0,
                                    borderLeft: '4px solid transparent',
                                    borderRight: '4px solid transparent',
                                    borderTop: '4px solid rgba(0,0,0,0.95)'
                                }}
                            />
                        </div>
                    )}
                </div>
            </div>
        );
    };
    
    return (
        <div className={clsx("relative", className)}>
            {/* Mobile: é‡æ–°è®¾è®¡çš„å‚ç›´æ—¶é—´è½´ */}
            <div className="block md:hidden">
                <div className="space-y-4">
                    {sortedPoints.map((point, index) => {
                        const IconComponent = iconMap[point.type] || StarIcon;
                        return (
                            <div key={point.id} className="relative">
                                {/* æ—¶é—´è½´è¿æ¥çº¿ - ç»§æ‰¿å½“å‰æ—¶é—´ç‚¹çš„é¢œè‰² */}
                                {index < sortedPoints.length - 1 && (
                                    <div 
                                        className="absolute left-4 top-10 w-0.5 h-8"
                                        style={{ 
                                            backgroundColor: point.foregroundColor || '#9CA3AF',
                                            transform: 'translateX(-1px)' 
                                        }}
                                    />
                                )}
                                
                                <div className="flex items-start space-x-3">
                                    {/* æ—¶é—´ç‚¹å›¾æ ‡ */}
                                    <div className="flex-shrink-0">
                                        <div
                                            className="w-8 h-8 rounded-full border-2 flex items-center justify-center shadow-lg"
                                            style={{
                                                backgroundColor: point.backgroundColor || 'rgba(255,255,255,0.1)',
                                                borderColor: point.foregroundColor || '#666'
                                            }}
                                        >
                                            <IconComponent 
                                                sx={{ 
                                                    fontSize: 16, 
                                                    color: point.foregroundColor || '#666' 
                                                }} 
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* å†…å®¹å¡ç‰‡ */}
                                    <div className="flex-1 min-w-0">
                                        <div className="bg-white/5 rounded-lg p-3 backdrop-blur-sm border border-white/10 shadow-sm">
                                            <div className="flex justify-between items-start gap-2">
                                                <h4 className="font-medium text-white text-sm flex-1">{point.name}</h4>
                                                <span className="text-xs text-gray-400 flex-shrink-0">
                                                    {formatTime(point.time)}
                                                </span>
                                            </div>
                                            {point.note && point.note.trim() && (
                                                <p className="text-gray-300 text-xs mt-2 leading-relaxed">{point.note}</p>
                                            )}
                                            {point.url && point.url.trim() && (
                                                <a 
                                                    href={point.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center text-blue-400 hover:text-blue-300 text-xs mt-2 transition-colors"
                                                >
                                                    ğŸ”— æŸ¥çœ‹è¯¦æƒ…
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
            
            {/* Desktop: Horizontal timeline - é‡æ–°è®¾è®¡ä¸ºçº¿æ®µé—´éš” */}
            <div className="hidden md:block">
                <div className="relative mb-4" style={{ height: '80px', paddingBottom: '20px' }}>
                    {/* æ—¶é—´ç‚¹ - ç®€åŒ–å¸ƒå±€ */}
                    {sortedPoints.map((point, index) => (
                        <TimelinePoint
                            key={point.id}
                            point={point}
                            position={getPointPosition(index, sortedPoints.length)}
                            index={index}
                        />
                    ))}
                    
                    {/* è¿æ¥çº¿æ®µ - åœ¨æ—¶é—´ç‚¹ä¹‹é—´ç»˜åˆ¶ */}
                    {sortedPoints.length > 1 && sortedPoints.map((point, index) => {
                        if (index >= sortedPoints.length - 1) return null;
                        
                        const currentPos = getPointPosition(index, sortedPoints.length);
                        const nextPos = getPointPosition(index + 1, sortedPoints.length);
                        
                        return (
                            <div
                                key={`line-${index}`}
                                className="absolute h-0.5"
                                style={{
                                    top: '40px',
                                    left: `${currentPos + 2}%`, // ä»å½“å‰ç‚¹ç¨å¾®åç§»å¼€å§‹
                                    width: `${nextPos - currentPos - 4}%`, // åˆ°ä¸‹ä¸€ä¸ªç‚¹ç¨å¾®åç§»ç»“æŸ
                                    backgroundColor: point.foregroundColor || '#9CA3AF'
                                }}
                            />
                        );
                    })}
                </div>
                
                {/* Time scale - Show actual time range */}
                <div className="flex justify-between text-xs text-gray-400 mt-2">
                    <span>
                        {sortedPoints.length > 0 ? formatTime(sortedPoints[0].time) : 'å¼€å§‹'}
                    </span>
                    <span>æ€»æ—¶é•¿: {Math.floor(duration / 60)}h{duration % 60}m</span>
                    <span>
                        {sortedPoints.length > 0 ? formatTime(sortedPoints[sortedPoints.length - 1].time) : 'ç»“æŸ'}
                    </span>
                </div>
            </div>
        </div>
    );
};

export default Timeline;
